<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Service Status</title>
    <link rel="icon" sizes="32x32" type="image/png" href="/templates/static/minator.jpg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: sans-serif;
        margin: 2em;
        background: #f5f5f5;
      }
      .card {
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        border-radius: 12px;
      }
      canvas {
        max-height: 450px;
      }
      h1 {
        text-align: center;
        color: #333;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 0 8px rgba(0,0,0,0.1);
      }
      th, td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      .healthy, .success {
        color: green;
        font-weight: bold;
      }
      .down, .critical, .failed {
        color: red;
        font-weight: bold;
      }
      .degraded, .inprogress {
        color: orange;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>Service Status</h1>
    <table>
      <thead>
        <tr>
          <th>Service</th>
          <th>Status</th>
          <th>Last Checked</th>
          <th>Message</th>
        </tr>
      </thead>
      <tbody id="status-body">
        <tr><td colspan="4" style="text-align:center;">Waiting for updates...</td></tr>
      </tbody>
    </table>
    <p id="last-updated" style="text-align: center; color: #777; font-size: 0.9em;"></p>

    <script>
      const tbody = document.getElementById("status-body");
      let es;
      function startSSE() {
        if (es) {
          es.close();
        }
        es = new EventSource("/api/service/status/stream");
        es.addEventListener("update", (event) => {
          try {
            const data = JSON.parse(event.data);
            renderStatus(data);
          } catch (e) {
            console.error("Failed to parse SSE data", e)
          }
        });
        es.onerror = (err) => {
          tbody.innerHTML = `
            <tr>
              <td colspan="4" style="color:red; text-align:center;">
                ‚ùå Lost connection to server. <br>
                Trying to reconnect automatically...<br>
                If this persists, refresh the page.
              </td>
            </tr>`;
        };
      }
      window.addEventListener('DOMContentLoaded', () => {
        startSSE();
        setInterval(startSSE, 1000 * 60 * 10); // restart every 10 minutes
      });

      function renderStatus(data) {
        tbody.innerHTML = '';
        Object.entries(data).sort(([_, a], [__, b]) => a.name.localeCompare(b.name)).forEach(([_, entry]) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${entry.name}</td>
            <td class="${entry.status}">${entry.status}</td>
            <td>${entry.timestamp}</td>
            <td>${entry.detail || ''}</td>
          `;
          tbody.appendChild(tr);
          document.getElementById("last-updated").textContent = "Last update: " + new Date().toLocaleString();
        });
      }
    </script>

    <div class="container py-4">
      <h1 class="text-center mb-4">üìä Hardware Metrics Dashboard</h1>
      <div class="d-flex justify-content-end align-items-center mb-3">
        <label for="groupSelect" class="me-2 fw-bold">Group by:</label>
        <select id="groupSelect" class="form-select w-auto">
          <option value="none">None</option>
          <option value="minute" selected>Minute</option>
          <option value="hour">Hour</option>
          <option value="day">Day</option>
          <option value="month">Month</option>
        </select>
      </div>
      <div class="card p-4 mb-4">
        <h4 class="mb-3">System Resource Usage</h4>
        <canvas id="metricsChart"></canvas>
      </div>
    </div>

    <script>
      let evtSource;
      const labels = [];
      const cpuData = [];
      const ramData = [];
      const diskData = [];

      const ctx = document.getElementById('metricsChart').getContext('2d');
      const metricsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: "CPU Usage (%)",
              data: cpuData,
              borderColor: "#ff4d4d",
              fill: false,
              tension: 0.3
            },
            {
              label: "RAM Usage (%)",
              data: ramData,
              borderColor: "#4da6ff",
              fill: false,
              tension: 0.3
            },
            {
              label: "Disk Usage (%)",
              data: diskData,
              borderColor: "#28a745",
              fill: false,
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: "index", intersect: false },
          stacked: false,
          plugins: {
            legend: { position: "top" },
            tooltip: { mode: "nearest" }
          },
          scales: {
            y: { beginAtZero: true, max: 100 },
            x: {
              ticks: {
                autoSkip: true,
                maxTicksLimit: 20,
                maxRotation: 90,
                minRotation: 45
              }
            },
          }
        }
      });

      function resetChartData() {
        labels.length = 0;
        cpuData.length = 0;
        ramData.length = 0;
        diskData.length = 0;
        metricsChart.update();
      }

      function connectSSE(group) {
        if (evtSource) evtSource.close();

        evtSource = new EventSource(`/api/hardware/metrics/stream?group=${group}`);

        evtSource.onmessage = function (event) {
          const data = JSON.parse(event.data);

          labels.push(data.timestamp);
          cpuData.push(data.cpu_percent);
          ramData.push(data.ram_percent);
          diskData.push(data.disk_percent);

          if (labels.length > 100) {
            labels.shift();
            cpuData.shift();
            ramData.shift();
            diskData.shift();
          }
          metricsChart.update();
        };

        evtSource.onerror = function (err) {
          console.error("SSE error:", err);
        };
      }

      document.getElementById("groupSelect").addEventListener("change", (e) => {
        resetChartData();
        connectSSE(e.target.value);
      });

      // Start initially with the default group value
      const defaultGroup = document.getElementById("groupSelect").value;
      connectSSE(defaultGroup);

      // Restart SSE connection every 10 minutes
      setInterval(() => {
        resetChartData();
        const currentGroup = document.getElementById("groupSelect").value;
        connectSSE(currentGroup);
      }, 600000);
    </script>
  </body>
</html>
